import os
import subprocess
import docker
from typing import Dict, Any

def scan_file(file_path: str) -> Dict[str, Any]:
    """
    Scan a file for malware using PEstudio in a Docker container
    
    Args:
        file_path: Path to the file to scan
        
    Returns:
        Dictionary containing scan results
    """
    try:
        # Get the directory containing the file
        upload_folder = os.path.dirname(file_path)
        filename = os.path.basename(file_path)
        
        # Initialize Docker client
        client = docker.from_env()
        
        # Run PEstudio in a container
        container = client.containers.run(
            "pestudio",  # Your PEstudio Docker image
            f"scan_file.sh {filename}",
            volumes={upload_folder: {'bind': '/app/uploads', 'mode': 'rw'}},
            detach=True
        )
        
        # Wait for the container to finish
        container.wait()
        
        # Get the scan logs
        logs = container.logs().decode('utf-8')
        
        # Clean up the container
        container.remove()
        
        # Analyze the logs
        is_malicious = "malicious" in logs.lower()
        scan_status = "Malicious" if is_malicious else "Safe"
        
        # Extract additional details from the scan
        scan_details = {
            "filename": filename,
            "status": scan_status,
            "analysis_time": os.path.getmtime(file_path),
            "file_size": os.path.getsize(file_path),
            "scan_logs": logs
        }
        
        return scan_details
        
    except Exception as e:
        return {
            "filename": os.path.basename(file_path),
            "status": "Error",
            "error": str(e)
        }
