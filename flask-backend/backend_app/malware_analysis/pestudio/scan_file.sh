#!/bin/bash

FILE_TO_SCAN="/app/uploads/$1"

if [[ ! -f "$FILE_TO_SCAN" ]]; then
    echo "Error: File not found: $FILE_TO_SCAN"
    exit 1
fi

echo "Starting analysis of: $FILE_TO_SCAN"

# Get file type
FILE_TYPE=$(file -b "$FILE_TO_SCAN")
echo "File type: $FILE_TYPE"

# Check for executable content
if [[ "$FILE_TYPE" == *"executable"* ]] || [[ "$FILE_TYPE" == *"DLL"* ]]; then
    echo "RESULT: MALICIOUS"
    echo "File appears to be executable"
    exit 2
fi

# Check file entropy (randomness) using xxd and awk
ENTROPY=$(xxd "$FILE_TO_SCAN" | awk '{for(i=2;i<=NF;i++)x=and(strtonum("0x"$i),255);if(x>32)c++}END{print c/NR}')

# If entropy is too high, might be packed/encrypted malware
if (( $(echo "$ENTROPY > 7.0" | bc -l) )); then
    echo "RESULT: MALICIOUS"
    echo "File has high entropy, possible packed/encrypted content"
    exit 2
fi

# Check for suspicious strings
if strings "$FILE_TO_SCAN" | grep -iE "virus|malware|trojan|backdoor|exploit|shell|hack|payload" > /dev/null; then
    echo "RESULT: MALICIOUS"
    echo "File contains suspicious strings"
    exit 2
fi

echo "RESULT: SAFE"
echo "No malicious indicators found"
exit 0
