import os
import subprocess
from flask import Flask, request, jsonify

app = Flask(__name__)
UPLOAD_FOLDER = os.path.join(os.getcwd(), 'uploads')  # Ensure path is correct
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

v@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files['file']
    if file:
        filepath = os.path.join(UPLOAD_FOLDER, file.filename)
        file.save(filepath)

        # ðŸ”½ ANALYZE WITH PESTUDIO via Docker
        analysis_result = analyze_file_with_pestudio(filepath)

        if analysis_result['status'] == 'malicious':
            return jsonify({'message': 'File is malicious'}), 400

        # âœ… Save to DB (only if safe)
        save_file_info_to_db(file.filename, analysis_result)
        return jsonify({'message': 'File is safe and stored'}), 200

    return jsonify({'message': 'No file uploaded'}), 400
def analyze_file_with_pestudio(filepath):
    try:
        docker_command = [
            "docker", "run", "--rm",
            "-v", f"{filepath}:/pestudio/uploaded_file.exe",
            "pestudio-image",  # your docker image name
            "/pestudio/pestudio.exe", "/pestudio/uploaded_file.exe"
        ]

        result = subprocess.run(docker_command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        output = result.stdout.decode()
        print(output)

        if "malicious" in output.lower():
            return {'status': 'malicious'}
        return {'status': 'safe'}

    except Exception as e:
        print(f"[ERROR] Malware analysis failed: {e}")
        return {'status': 'error', 'error': str(e)}